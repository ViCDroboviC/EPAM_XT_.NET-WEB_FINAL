
@using Entities;
@using PL.pages;
@using DependencyResolver;
@{
    Layout = "~/pages/_basicLayout.cshtml";
    var bll = Resolver.bll;

    UserContainer.currentUser = bll.GetUserInfo();

    var currentUser = UserContainer.currentUser;

    string message = null;

    string tag = Request.QueryString["id"];
    var success = Int32.TryParse(tag, out int carId);

    if (success)
    {
        CarContainer.currentCar = currentUser.CarsList.FirstOrDefault(wantedCar => wantedCar.id == carId);
    }

    var carToDisplay = CarContainer.currentCar;

    var mileageToSet = Request["mileAgeDelta"];
    int newMileage;

    if (IsPost)
    {
        if (int.TryParse(mileageToSet, out newMileage))
        {
            int.TryParse(mileageToSet, out newMileage);
            if (newMileage < carToDisplay.totalMileage)
            {
                message = "Текущий пробег не может быть меньше предыдущего.";
            }
            else if (newMileage > carToDisplay.totalMileage)
            {
                message = null;

                bll.RfreshCarMileage(carToDisplay.id, newMileage);
                Response.Redirect("~/pages/carinfo.cshtml?id=" + @carToDisplay.id);
            }
            else
            {
                message = "Непредвиденная ошибка";

            }
        }
    }
}
<section id="carinfo">
    <p>
        <h2>@carToDisplay.fullName</h2>
        <span>Общий пробег: </span><span>@carToDisplay.totalMileage</span><span> км</span>

    </p>
    <form action="~/pages/carinfo.cshtml?id=@carToDisplay.id" method="post">
        <input type="number" name="mileAgeDelta" placeholder="Текущий пробег" />
        <button type="submit">обновить пробег</button>
    </form>
    @if (message != null)
    {
        <p id="warning">@message</p>
    }
    <p>
        <h3>Масло</h3>
        <span>До следующей замены масла</span><span>@carToDisplay.nextOilRefresh</span><span> км</span><br>
        <button>проведена замена масла</button>
    </p>
    <p>
        <h3>Привод ГРМ</h3>
        <span>Ресурс до замены: </span><span>@carToDisplay.remainingTimingDriveRes</span><span> км</span><br>
        <button>Проведено техобслуживание</button>
    </p>
    <p>
        <h3>Силовая установка</h3>
        <span>Ресурс до обслуживания: </span><span>@carToDisplay.remainingEngineRes</span><span> км</span><br>
        <button>Проведено техобслуживание</button>
    </p>
    <p>
        <h3>Детали подвески</h3>
        <span>Ресурс до замены: </span><span>@carToDisplay.remainingSuspensionRes</span><span> км</span><br>
        <button>Проведено техобслуживание</button>
    </p>
    <p>
        <h3>Рулевое управление</h3>
        <span>Ресурс до замены: </span><span>@carToDisplay.remainingSteeringRes</span><span> км</span><br>
        <button>Проведено техобслуживание</button>
    </p>
    <p>
        <h3>Тормозная система</h3>
        <span>Ресурс до замены: </span><span>@carToDisplay.remainingBrakesRes</span><span> км</span><br>
        <button>Проведено техобслуживание</button>
    </p>
</section>

<section id="mycars">
    <h2>Мой гараж:</h2>
    @foreach (Car car in currentUser.CarsList)
    {
        CarContainer.currentCar = car;
        @RenderPage("~/pages/_UserGarage.cshtml")
    }
    <button id="addCarToGarage" onclick="show()">добавить</button>
</section>


